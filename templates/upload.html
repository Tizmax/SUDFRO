<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Upload PDF</title><html>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

    <div class="container">
        {% include 'header.html' %}
        <h1>Upload de fichiers PDF</h1>

        <form id="uploadForm">
            <div id="dropzone" class="dropzone">D√©posez des fichiers PDF ici ou cliquez</div>
            <input type="file" id="fileInput" accept="application/pdf" multiple hidden>
            <ul id="fileList"></ul>
            <div class="button-group">
                <button type="button" class="btn-secondary" onclick="debugFiles()">Debug</button>
                <button type="button" class="btn-primary"onclick="uploadFiles()">Importer dans l'ERP</button>
            </div>
        </form>
        
    </div>

    <script>
        const dropzone = document.getElementById("dropzone");
        const fileInput = document.getElementById("fileInput");
        const fileList = document.getElementById("fileList");
        let selectedFiles = [];

        dropzone.addEventListener("click", () => fileInput.click());

        dropzone.addEventListener("dragover", (event) => {
            event.preventDefault();
            dropzone.classList.add("dragover");
        });

        dropzone.addEventListener("dragleave", () => dropzone.classList.remove("dragover"));

        dropzone.addEventListener("drop", (event) => {
            event.preventDefault();
            dropzone.classList.remove("dragover");

            handleFiles(event.dataTransfer.files);
        });

        fileInput.addEventListener("change", () => {
            handleFiles(fileInput.files);
        });

        function handleFiles(files) {
            selectedFiles = Array.from(files).filter(file => file.type === "application/pdf");

            fileList.innerHTML = "";
            selectedFiles.forEach(file => {
                let li = document.createElement("li");
                li.textContent = file.name;
                fileList.appendChild(li);
            });

            if (selectedFiles.length === 0) {
                alert("Veuillez s√©lectionner uniquement des fichiers PDF.");
            }
        }

    async function uploadFiles() {
        await submitForm("/upload");
    }

    async function debugFiles() {
        await submitForm("/debug");
    }

    async function submitForm(action) {
        if (selectedFiles.length === 0) {
            alert("Aucun fichier s√©lectionn√©.");
            return;
        }

        let formData = new FormData();
        selectedFiles.forEach(file => formData.append("files", file));

        let response = await fetch(action, {
            method: "POST",
            body: formData
        });

        if (response.redirected) {
            window.location.href = response.url;  // üîÑ Redirection pour le Debug
        } else if (response.ok) {
            alert("Fichiers t√©l√©vers√©s avec succ√®s !");
            fileList.innerHTML = "";
            selectedFiles = [];
        } else {
            alert("Erreur lors du traitement !");
        }
    }
    </script>
</body>
</html>

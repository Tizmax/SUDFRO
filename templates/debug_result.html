<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>RÃ©sultat Debug</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container-debug">
        {% include 'header.html' %}
        <h1>Ã‰dition du CSV</h1>

        <!-- ðŸ”¹ Partie dynamique : Affichage des fichiers gÃ©nÃ©rÃ©s -->
        <table id="csvTable">
            <thead>
                <tr id="headerRow"></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div class="button-group">
            <button class="btn-primary" onclick="saveCsv()">Enregistrer les modifications</button>
        </div>

        
        <!-- ðŸ”¹ Partie statique : Explication de l'outil -->
        <div class="documentation">
            <h2>Comment utiliser l'application ?</h2>
            <p>1. DÃ©posez un fichier PDF sur la page principale.</p>
            <p>3. Choisissez "Debug" pour voir comment le fichier est transformÃ©.</p>
            <p>4. La section ci-dessus vous montre les donnÃ©es lues dans le BL.</p>
            <p>4. Modifiez le tableau ci-dessus de sorte que toutes les informations soient correctes</p>
            <p>4. Enregistrez les modifications</p>
        </div>
    </div>

    <script>
        let csvData = `{{ csv_content | safe }}`.trim();

        function generateTable(csv) {
            const tableBody = document.getElementById("tableBody");
            const headerRow = document.getElementById("headerRow");

            tableBody.innerHTML = "";
            headerRow.innerHTML = "";

            let rows = csv.split("\n").map(row => row.split(","));

            // ðŸ”¹ CrÃ©ation de la 1Ã¨re ligne comme en-tÃªte
            rows[0].forEach(col => {
                let th = document.createElement("th");
                th.textContent = col;
                headerRow.appendChild(th);
            });

            // ðŸ”¹ CrÃ©ation des autres lignes
            rows.slice(1).forEach((row, rowIndex) => {
                let tr = document.createElement("tr");

                row.forEach(cell => {
                    let td = document.createElement(rowIndex === 1 ? "th" : "td"); // ðŸ†• 3Ã¨me ligne = <th> au lieu de <td>
                    td.textContent = cell;

                    if (rowIndex === 1) {
                        td.style.fontWeight = "bold"; // ðŸ†• Mise en gras pour la 3Ã¨me ligne (index 2 du CSV)
                    } else {
                        td.contentEditable = "true"; // ðŸ†• Toutes les autres cellules restent modifiables
                    }

                    tr.appendChild(td);
                });

                tableBody.appendChild(tr);
            });
        }


        function saveCsv() {
            let newCsvData = [];
            
            // ðŸ”¹ RÃ©cupÃ©rer la premiÃ¨re ligne d'en-tÃªte
            let headerCells = document.querySelectorAll("#headerRow th");
            let headerRow = Array.from(headerCells).map(cell => cell.textContent);
            newCsvData.push(headerRow.join(",")); // ðŸ†• Ajoute l'en-tÃªte

            // ðŸ”¹ RÃ©cupÃ©rer toutes les lignes du tableau
            const rows = document.querySelectorAll("#tableBody tr");

            rows.forEach(row => {
                let rowData = [];
                row.querySelectorAll("td, th").forEach(cell => { // ðŸ†• Inclure aussi les <th>
                    rowData.push(cell.textContent);
                });
                newCsvData.push(rowData.join(",")); // ðŸ†• Ajoute chaque ligne correctement formatÃ©e
            });

            fetch("/update_csv", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    filename: "{{ csv_filename }}",
                    content: newCsvData.join("\n")
                })
            }).then(response => {
                if (response.ok) {
                    alert("Modifications enregistrÃ©es !");
                } else {
                    alert("Erreur lors de l'enregistrement.");
                }
            });
        }


        generateTable(csvData);
    </script>
</body>
</html>

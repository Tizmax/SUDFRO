<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Résultat Debug</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container-debug">
        {% include 'header.html' %}
        <h1>Édition du CSV</h1>

        <!-- Partie dynamique : Affichage du tableau de données modifiables -->
        <table id="csvTable">
            <thead>
                <tr id="headerRow"></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div class="button-group">
            <button class="btn-primary" onclick="saveCsv()">Enregistrer les modifications</button>
        </div>

        
        <!-- Partie statique : Documentation -->
        <div class="documentation">
            <h2>Comment entrainer l'IA sur un nouveau fournisseur ?</h2>
            <p>1. Déposez un BL au format PDF sur la page principale.</p>
            <p>2. Choisissez "Debug" pour voir comment le fichier est transformé.</p>
            <p>3. La section ci-dessus vous montre les données lues dans le BL, celles-ci contiennent probablement des erreurs, corrigez-les.</p>
            <p>5. Enregistrez les modifications</p>
            <p>Vous arrivez alors sur une nouvelle page</p>
            <p>6. Copiez le contenu intitulé "entrée" et "sortie" dans les boites correspondante sur le site de mistralAI</p>
        </div>
    </div>

    <script>
        let csvData = `{{ csv_content | safe }}`.trim();

        // Génère le tableau issu du CSV avec les données modifiables
        function generateTable(csv) {
            const tableBody = document.getElementById("tableBody");
            const headerRow = document.getElementById("headerRow");

            tableBody.innerHTML = "";
            headerRow.innerHTML = "";

            let rows = csv.split("\n").map(row => row.split(","));

            // Création de la 1ère ligne comme en-tête
            rows[0].forEach(col => {
                let th = document.createElement("th");
                th.textContent = col;
                headerRow.appendChild(th);
            });

            // Création des autres lignes
            rows.slice(1).forEach((row, rowIndex) => {
                let tr = document.createElement("tr");

                row.forEach(cell => {
                    let td = document.createElement(rowIndex === 1 ? "th" : "td"); // 3ème ligne = <th> au lieu de <td>
                    td.textContent = cell;

                    if (rowIndex === 1) {
                        td.style.fontWeight = "bold"; // Mise en gras pour la 3ème ligne (index 2 du CSV)
                    } else {
                        td.contentEditable = "true"; // Toutes les autres cellules restent modifiables
                    }

                    tr.appendChild(td);
                });

                tableBody.appendChild(tr);
            });
        }

        // Enregistre les modifications du tableau dans le CSV
        function saveCsv() {
            let newCsvData = [];
            
            let headerCells = document.querySelectorAll("#headerRow th");
            let headerRow = Array.from(headerCells).map(cell => cell.textContent);
            newCsvData.push(headerRow.join(",")); 

            const rows = document.querySelectorAll("#tableBody tr");

            rows.forEach(row => {
                let rowData = [];
                row.querySelectorAll("td, th").forEach(cell => { 
                    rowData.push(cell.textContent);
                });
                newCsvData.push(rowData.join(","));
            });

            fetch("/update_csv", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    filename: "{{ csv_filename }}",
                    content: newCsvData.join("\n")
                })
            }).then(response => {
                if (response.ok) {
                    alert("Modifications enregistrées !");
                } else {
                    alert("Erreur lors de l'enregistrement.");
                }
            });
        }


        generateTable(csvData);
    </script>
</body>
</html>
